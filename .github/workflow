name: Validate RSA Key

on:
  repository_dispatch:
    types: [validate-rsa-key]

jobs:
  validate-key:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Set Up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'  # Adjust as needed

      - name: Install Dependencies
        run: |
          npm install jsonwebtoken

      - name: Retrieve RSA Private Key
        id: get_key
        run: |
          echo "${{ secrets.VAULT_RSA_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem
          echo "Private key retrieved successfully."

      - name: Validate RSA Key
        id: validate_key
        run: |
          echo "Validating RSA key..."
          NODE_ENV=test node -e "
          const fs = require('fs');
          const jwt = require('jsonwebtoken');

          try {
            const privateKey = fs.readFileSync('private_key.pem');
            console.log('Private key loaded successfully.');

            const token = jwt.sign({ data: 'test' }, privateKey, { algorithm: 'RS256' });
            console.log('Token generated successfully:', token);
          } catch (err) {
            console.error('Error:', err.message);
            process.exit(1);
          }
          "

      - name: Clean up
        run: |
          echo "Cleaning up..."
          rm -f private_key.pem
