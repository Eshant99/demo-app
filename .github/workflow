name: Validate RSA Key

on:
  push:
    branches:
      - main

jobs:
  validate-key:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Set Up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'  # Adjust to your Node.js version

      - name: Install Dependencies
        run: |
          npm install jsonwebtoken  # Install jsonwebtoken package to test the key

      - name: Retrieve RSA Private Key
        id: get_key
        run: |
          echo "${{ secrets.VAULT_RSA_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: Validate RSA Key
        id: validate_key
        run: |
          # Attempt to create a JWT token using the private key
          NODE_ENV=test node -e "
          const fs = require('fs');
          const jwt = require('jsonwebtoken');

          try {
            const privateKey = fs.readFileSync('private_key.pem');
            const token = jwt.sign({ data: 'test' }, privateKey, { algorithm: 'RS256' });
            console.log('Token generated successfully:', token);
          } catch (err) {
            console.error('Error:', err.message);
            process.exit(1);
          }
          "

      - name: Clean up
        run: |
          rm private_key.pem
